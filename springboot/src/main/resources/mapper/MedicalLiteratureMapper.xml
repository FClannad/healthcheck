<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.MedicalLiteratureMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.example.entity.MedicalLiterature">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="title" jdbcType="VARCHAR" property="title"/>
        <result column="authors" jdbcType="VARCHAR" property="authors"/>
        <result column="journal" jdbcType="VARCHAR" property="journal"/>
        <result column="publish_date" jdbcType="VARCHAR" property="publishDate"/>
        <result column="abstract_content" jdbcType="LONGVARCHAR" property="abstractContent"/>
        <result column="keywords" jdbcType="VARCHAR" property="keywords"/>
        <result column="source_url" jdbcType="VARCHAR" property="sourceUrl"/>
        <result column="crawl_source" jdbcType="VARCHAR" property="crawlSource"/>
        <result column="status" jdbcType="VARCHAR" property="status"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        id, title, authors, journal, publish_date, abstract_content, keywords,
        source_url, crawl_source, status, create_time
    </sql>

    <!-- 插入文献 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO medical_literature (
            title, authors, journal, publish_date, abstract_content, keywords,
            source_url, crawl_source, status, create_time
        ) VALUES (
            #{title}, #{authors}, #{journal}, #{publishDate}, #{abstractContent}, #{keywords},
            #{sourceUrl}, #{crawlSource}, #{status}, #{createTime}
        )
    </insert>

    <!-- 批量插入文献 -->
    <insert id="batchInsert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO medical_literature (
            title, authors, journal, publish_date, abstract_content, keywords,
            source_url, crawl_source, status, create_time
        ) VALUES
        <foreach collection="literatures" item="item" separator=",">
            (
                #{item.title}, #{item.authors}, #{item.journal}, #{item.publishDate},
                #{item.abstractContent}, #{item.keywords},
                #{item.sourceUrl}, #{item.crawlSource}, #{item.status}, #{item.createTime}
            )
        </foreach>
    </insert>

    <!-- 更新文献 -->
    <update id="updateById">
        UPDATE medical_literature
        <set>
            <if test="title != null and title != ''">title = #{title},</if>
            <if test="authors != null and authors != ''">authors = #{authors},</if>
            <if test="journal != null and journal != ''">journal = #{journal},</if>
            <if test="publishDate != null and publishDate != ''">publish_date = #{publishDate},</if>
            <if test="abstractContent != null">abstract_content = #{abstractContent},</if>
            <if test="keywords != null">keywords = #{keywords},</if>
            <if test="sourceUrl != null">source_url = #{sourceUrl},</if>
            <if test="crawlSource != null">crawl_source = #{crawlSource},</if>
            <if test="status != null">status = #{status}</if>
        </set>
        WHERE id = #{id}
    </update>



    <!-- 高级搜索文献 -->
    <select id="searchLiterature" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM medical_literature
        <where>
            status = 'active'
            <if test="keyword != null and keyword != ''">
                AND (
                    title LIKE CONCAT('%', #{keyword}, '%')
                    OR authors LIKE CONCAT('%', #{keyword}, '%')
                    OR abstract_content LIKE CONCAT('%', #{keyword}, '%')
                    OR keywords LIKE CONCAT('%', #{keyword}, '%')
                    OR journal LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <!-- category和language字段已移除 -->
            <!-- <if test="category != null and category != ''">
                AND category = #{category}
            </if>
            <if test="language != null and language != ''">
                AND language = #{language}
            </if> -->
            <if test="startDate != null and startDate != ''">
                AND publish_date >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND publish_date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY
            CASE
                WHEN title LIKE CONCAT('%', IFNULL(#{keyword}, ''), '%') THEN 1
                WHEN authors LIKE CONCAT('%', IFNULL(#{keyword}, ''), '%') THEN 2
                WHEN keywords LIKE CONCAT('%', IFNULL(#{keyword}, ''), '%') THEN 3
                ELSE 4
            END,
            create_time DESC
    </select>

</mapper>